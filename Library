local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")

local UIManager = {}

local _state = {
	screenGui = nil,
	overlayFrame = nil,
	contentContainer = nil,
	toggleButton = nil,
	statusLabel = nil,
	timerLabel = nil,
	playerInfoLabel = nil,
	logoImage = nil,
	clockStartTime = 0,
	lastSecondUpdate = -1,
	heartbeatConnection = nil,
	isVisible = true,
	isAnimating = false,
	defaultPosition = nil,
	hoverPosition = nil,
	activeTween = nil,
	eventConnections = {}
}

local ANIMATION_SHOW = TweenInfo.new(0.2, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)
local ANIMATION_HIDE = TweenInfo.new(0.15)
local ANIMATION_BUTTON = TweenInfo.new(0.12, Enum.EasingStyle.Quad, Enum.EasingDirection.Out)

local function safeDisconnect(connection)
	local success, errorMessage = pcall(function()
		if connection and typeof(connection) == "RBXScriptConnection" then
			connection:Disconnect()
		end
	end)
	if not success then
		warn("[UIManager] Connection disconnect failed:", errorMessage)
	end
end

local function cleanup()
	local success, errorMessage = xpcall(function()
		for _, connection in pairs(_state.eventConnections) do
			safeDisconnect(connection)
		end
		
		if _state.activeTween then
			pcall(function() _state.activeTween:Cancel() end)
			_state.activeTween = nil
		end
		
		if _state.heartbeatConnection then
			safeDisconnect(_state.heartbeatConnection)
			_state.heartbeatConnection = nil
		end
		
		if _state.screenGui then
			_state.screenGui:Destroy()
		end
		
		table.clear(_state.eventConnections)
		table.clear(_state)
	end, function(message)
		return debug.traceback(message, 2)
	end)
	
	if not success then
		warn("[UIManager] Cleanup failed:", errorMessage)
	end
end

local function applyTransparencyToDescendants(parentElement, transparencyValue)
	local success, errorMessage = pcall(function()
		for _, descendant in ipairs(parentElement:GetDescendants()) do
			if descendant:IsA("TextLabel") then
				descendant.TextTransparency = transparencyValue
			elseif descendant:IsA("ImageLabel") or descendant:IsA("ImageButton") then
				descendant.ImageTransparency = transparencyValue
			elseif descendant:IsA("Frame") then
				descendant.BackgroundTransparency = transparencyValue
			end
		end
	end)
	
	if not success then
		warn("[UIManager] Apply transparency failed:", errorMessage)
	end
end

local function createTween(element, tweenInfo, properties)
	local success, result = pcall(function()
		return TweenService:Create(element, tweenInfo, properties)
	end)
	
	if success then
		pcall(function() result:Play() end)
		return result
	else
		warn("[UIManager] Tween creation failed:", result)
		return nil
	end
end

local function showInterface()
	if _state.isAnimating or _state.isVisible then return end
	
	local success, errorMessage = xpcall(function()
		_state.isAnimating = true
		_state.overlayFrame.Visible = true
		_state.overlayFrame.BackgroundTransparency = 1
		applyTransparencyToDescendants(_state.overlayFrame, 1)

		local backgroundTween = createTween(_state.overlayFrame, ANIMATION_SHOW, {BackgroundTransparency = 0})

		for _, descendant in ipairs(_state.overlayFrame:GetDescendants()) do
			if descendant:IsA("TextLabel") then
				createTween(descendant, ANIMATION_SHOW, {TextTransparency = 0})
			elseif descendant:IsA("ImageLabel") or descendant:IsA("ImageButton") then
				createTween(descendant, ANIMATION_SHOW, {ImageTransparency = 0})
			end
		end

		if backgroundTween then
			backgroundTween.Completed:Wait()
		else
			task.wait(0.2)
		end
		
		_state.isVisible = true
		_state.isAnimating = false
	end, function(message)
		return debug.traceback(message, 2)
	end)
	
	if not success then
		warn("[UIManager] Show interface failed:", errorMessage)
		_state.isAnimating = false
	end
end

local function hideInterface()
	if _state.isAnimating or not _state.isVisible then return end
	
	local success, errorMessage = xpcall(function()
		_state.isAnimating = true

		for _, descendant in ipairs(_state.overlayFrame:GetDescendants()) do
			if descendant:IsA("TextLabel") then
				createTween(descendant, ANIMATION_HIDE, {TextTransparency = 1})
			elseif descendant:IsA("ImageLabel") or descendant:IsA("ImageButton") then
				createTween(descendant, ANIMATION_HIDE, {ImageTransparency = 1})
			end
		end

		local backgroundTween = createTween(_state.overlayFrame, ANIMATION_HIDE, {BackgroundTransparency = 1})
		
		if backgroundTween then
			backgroundTween.Completed:Wait()
		else
			task.wait(0.15)
		end

		_state.overlayFrame.Visible = false
		_state.isVisible = false
		_state.isAnimating = false
	end, function(message)
		return debug.traceback(message, 2)
	end)
	
	if not success then
		warn("[UIManager] Hide interface failed:", errorMessage)
		_state.isAnimating = false
	end
end

local function toggleInterface()
	local success, errorMessage = pcall(function()
		if _state.isVisible then 
			hideInterface() 
		else 
			showInterface() 
		end
	end)
	
	if not success then
		warn("[UIManager] Toggle interface failed:", errorMessage)
	end
end

local function animateToggleButton(targetPosition)
	local success, errorMessage = pcall(function()
		if _state.activeTween then
			_state.activeTween:Cancel()
		end
		_state.activeTween = createTween(_state.toggleButton, ANIMATION_BUTTON, {Position = targetPosition})
	end)
	
	if not success then
		warn("[UIManager] Toggle button animation failed:", errorMessage)
	end
end

local function createTextLabel(parentElement, labelText, yPosition, maxTextSize)
	local success, textLabel = pcall(function()
		local label = Instance.new("TextLabel")
		label.Parent = parentElement
		label.AnchorPoint = Vector2.new(0.5, 0.5)
		label.Position = UDim2.fromScale(0.5, yPosition)
		label.Size = UDim2.fromScale(1, 0.1)
		label.BackgroundTransparency = 1
		label.Font = Enum.Font.FredokaOne
		label.TextColor3 = Color3.new(1, 1, 1)
		label.TextScaled = true
		label.TextWrapped = true
		label.Text = labelText

		local sizeConstraint = Instance.new("UITextSizeConstraint")
		sizeConstraint.Parent = label
		sizeConstraint.MinTextSize = 18
		sizeConstraint.MaxTextSize = maxTextSize

		return label
	end)
	
	if not success then
		warn("[UIManager] Text label creation failed:", textLabel)
		return nil
	end
	
	return textLabel
end

function UIManager.Initialize(configuration)
	local success, result = xpcall(function()
		configuration = configuration or {}
		cleanup()

		local localPlayer = Players.LocalPlayer
		local playerGui = localPlayer:WaitForChild("PlayerGui")

		local playerDisplayText = tostring(configuration.PLAYER_TEXT or ("Name : " .. localPlayer.Name))
		local maxTextSize = tonumber(configuration.TEXT_MAX) or 72
		local hoverOffset = tonumber(configuration.HOVER_RIGHT) or 40

		local screenGui = Instance.new("ScreenGui")
		screenGui.Name = "KaitunUi"
		screenGui.IgnoreGuiInset = true
		screenGui.ResetOnSpawn = false
		screenGui.Parent = playerGui

		local toggleButton = Instance.new("ImageButton")
		toggleButton.Parent = screenGui
		toggleButton.Size = UDim2.fromScale(0.05, 0.09)
		toggleButton.Position = UDim2.fromScale(-0.02, 0.2)
		toggleButton.BackgroundTransparency = 1
		toggleButton.Image = "rbxassetid://131686022689169"
		toggleButton.ZIndex = 100
		Instance.new("UICorner", toggleButton).CornerRadius = UDim.new(1, 0)

		local overlayFrame = Instance.new("Frame")
		overlayFrame.Parent = screenGui
		overlayFrame.Size = UDim2.fromScale(1, 1)
		overlayFrame.Position = UDim2.fromScale(0, 0)
		overlayFrame.BackgroundColor3 = Color3.fromRGB(5, 5, 5)

		local centerFrame = Instance.new("Frame")
		centerFrame.Parent = overlayFrame
		centerFrame.AnchorPoint = Vector2.new(0.5, 0.5)
		centerFrame.Position = UDim2.fromScale(0.5, 0.5)
		centerFrame.Size = UDim2.fromScale(1, 1)
		centerFrame.BackgroundTransparency = 1

		local contentContainer = Instance.new("Frame")
		contentContainer.Parent = centerFrame
		contentContainer.AnchorPoint = Vector2.new(0.5, 0.5)
		contentContainer.Position = UDim2.fromScale(0.5, 0.5)
		contentContainer.Size = UDim2.fromScale(0.9, 0.9)
		contentContainer.BackgroundTransparency = 1

		local aspectRatio = Instance.new("UIAspectRatioConstraint")
		aspectRatio.Parent = contentContainer
		aspectRatio.AspectRatio = 16 / 9
		aspectRatio.AspectType = Enum.AspectType.ScaleWithParentSize

		local logoImage = Instance.new("ImageLabel")
		logoImage.Parent = contentContainer
		logoImage.AnchorPoint = Vector2.new(0.5, 0.5)
		logoImage.Position = UDim2.fromScale(0.5, 0.5)
		logoImage.Size = UDim2.fromScale(0.35, 0.7)
		logoImage.BackgroundTransparency = 1
		logoImage.Image = "rbxassetid://132337846628803"
		logoImage.ImageTransparency = 0
		logoImage.ZIndex = 5

		local serviceNameLabel = createTextLabel(contentContainer, "Shino Farm Services", 0.08, maxTextSize)
		local playerNameLabel = createTextLabel(contentContainer, playerDisplayText, 0.17, maxTextSize)
		local statusLabel = createTextLabel(contentContainer, "Now do : Ready", 0.78, maxTextSize)
		local timerLabel = createTextLabel(contentContainer, "Time : 0 Hour 0 Minutes 0 Seconds", 0.88, maxTextSize)

		_state.screenGui = screenGui
		_state.toggleButton = toggleButton
		_state.overlayFrame = overlayFrame
		_state.contentContainer = contentContainer
		_state.statusLabel = statusLabel
		_state.timerLabel = timerLabel
		_state.playerInfoLabel = playerNameLabel
		_state.logoImage = logoImage

		_state.defaultPosition = toggleButton.Position
		_state.hoverPosition = UDim2.new(
			_state.defaultPosition.X.Scale,
			_state.defaultPosition.X.Offset + hoverOffset,
			_state.defaultPosition.Y.Scale,
			_state.defaultPosition.Y.Offset
		)

		_state.eventConnections.buttonActivated = toggleButton.Activated:Connect(toggleInterface)
		_state.eventConnections.buttonHoverEnter = toggleButton.MouseEnter:Connect(function() 
			animateToggleButton(_state.hoverPosition) 
		end)
		_state.eventConnections.buttonHoverLeave = toggleButton.MouseLeave:Connect(function() 
			animateToggleButton(_state.defaultPosition) 
		end)

		_state.clockStartTime = os.clock()
		_state.lastSecondUpdate = -1

		_state.heartbeatConnection = RunService.Heartbeat:Connect(function()
			local timerSuccess, timerError = pcall(function()
				local elapsedSeconds = math.floor(os.clock() - _state.clockStartTime)
				if elapsedSeconds ~= _state.lastSecondUpdate then
					_state.lastSecondUpdate = elapsedSeconds
					if timerLabel then
						timerLabel.Text = string.format(
							"Time : %d Hour %d Minutes %d Seconds",
							elapsedSeconds // 3600, 
							(elapsedSeconds % 3600) // 60, 
							elapsedSeconds % 60
						)
					end
				end
			end)
			
			if not timerSuccess then
				warn("[UIManager] Timer update failed:", timerError)
			end
		end)

		return UIManager
	end, function(message)
		return debug.traceback(message, 2)
	end)
	
	if not success then
		warn("[UIManager] Initialization failed:", result)
		cleanup()
		return nil
	end
	
	return result
end

function UIManager.SetStatus(statusText)
	local success, errorMessage = pcall(function()
		if _state.statusLabel then
			_state.statusLabel.Text = "Now do : " .. tostring(statusText or "")
		end
	end)
	
	if not success then
		warn("[UIManager] Set status failed:", errorMessage)
	end
end

function UIManager.SetPlayerInfo(playerText)
	local success, errorMessage = pcall(function()
		if _state.playerInfoLabel then
			_state.playerInfoLabel.Text = tostring(playerText or "")
		end
	end)
	
	if not success then
		warn("[UIManager] Set player info failed:", errorMessage)
	end
end

function UIManager.Show()
	showInterface()
end

function UIManager.Hide()
	hideInterface()
end

function UIManager.Toggle()
	toggleInterface()
end

function UIManager.IsVisible()
	return _state.isVisible
end

function UIManager.Destroy()
	cleanup()
end

return UIManager
